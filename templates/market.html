{% extends "base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/market.css">
{% endblock %}

{% block content %}
<div class="container">
    <!-- Market Overview Cards -->
    <div class="market-overview">
        <div class="overview-card">
            <div class="overview-icon">üìà</div>
            <div class="overview-content">
                <div class="overview-number">{{ insights.total_crops }}</div>
                <div class="overview-label">‡§ï‡•Å‡§≤ ‡§´‡§∏‡§≤‡•á‡§Ç</div>
            </div>
        </div>
        <div class="overview-card success">
            <div class="overview-icon">üü¢</div>
            <div class="overview-content">
                <div class="overview-number">{{ insights.rising_crops }}</div>
                <div class="overview-label">‡§¨‡§¢‡§º‡§§‡•Ä ‡§ï‡•Ä‡§Æ‡§§‡•á‡§Ç</div>
            </div>
        </div>
        <div class="overview-card danger">
            <div class="overview-icon">üî¥</div>
            <div class="overview-content">
                <div class="overview-number">{{ insights.falling_crops }}</div>
                <div class="overview-label">‡§ó‡§ø‡§∞‡§§‡•Ä ‡§ï‡•Ä‡§Æ‡§§‡•á‡§Ç</div>
            </div>
        </div>
        <div class="overview-card {{ 'success' if insights.avg_change > 0 else 'danger' }}">
            <div class="overview-icon">{{ 'üìä' if insights.avg_change > 0 else 'üìâ' }}</div>
            <div class="overview-content">
                <div class="overview-number">{{ insights.avg_change }}%</div>
                <div class="overview-label">‡§î‡§∏‡§§ ‡§¨‡§¶‡§≤‡§æ‡§µ</div>
            </div>
        </div>
    </div>

    <!-- Market Sentiment & Insights -->
    <div class="market-insights-section">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">üìä ‡§Æ‡§æ‡§∞‡•ç‡§ï‡•á‡§ü ‡§á‡§®‡§∏‡§æ‡§á‡§ü‡•ç‡§∏</h2>
                <div class="sentiment-badge {{ 'bullish' if insights.market_sentiment == 'Bullish' else 'bearish' }}">
                    {{ insights.market_sentiment }} ‡§¨‡§æ‡§ú‡§æ‡§∞
                </div>
            </div>

            <div class="insights-grid">
                <div class="insight-item">
                    <h4>‡§∏‡§¨‡§∏‡•á ‡§ú‡•ç‡§Ø‡§æ‡§¶‡§æ ‡§¨‡§¢‡§º‡§®‡•á ‡§µ‡§æ‡§≤‡•Ä ‡§´‡§∏‡§≤</h4>
                    {% if insights.top_gainer %}
                    <div class="crop-highlight success">
                        <span class="crop-name">{{ insights.top_gainer.crop_name }}</span>
                        <span class="price-change">+{{ insights.top_gainer.percentage_change }}%</span>
                    </div>
                    {% endif %}
                </div>

                <div class="insight-item">
                    <h4>‡§∏‡§¨‡§∏‡•á ‡§ú‡•ç‡§Ø‡§æ‡§¶‡§æ ‡§ó‡§ø‡§∞‡§®‡•á ‡§µ‡§æ‡§≤‡•Ä ‡§´‡§∏‡§≤</h4>
                    {% if insights.top_loser %}
                    <div class="crop-highlight danger">
                        <span class="crop-name">{{ insights.top_loser.crop_name }}</span>
                        <span class="price-change">{{ insights.top_loser.percentage_change }}%</span>
                    </div>
                    {% endif %}
                </div>

                <div class="insight-item">
                    <h4>‡§Æ‡§æ‡§∞‡•ç‡§ï‡•á‡§ü ‡§ü‡•ç‡§∞‡•á‡§Ç‡§°</h4>
                    <div class="trend-indicator">
                        <span class="trend-arrow {{ 'up' if insights.avg_change > 0 else 'down' }}">
                            {{ '‚ÜóÔ∏è' if insights.avg_change > 0 else '‚ÜòÔ∏è' }}
                        </span>
                        <span>{{ '‡§§‡•á‡§ú‡•Ä ‡§ï‡•Ä ‡§ì‡§∞' if insights.avg_change > 0 else '‡§Æ‡§Ç‡§¶‡•Ä ‡§ï‡•Ä ‡§ì‡§∞' }}</span>
                    </div>
                </div>

                <div class="insight-item">
                    <h4>‡§Ü‡§ú ‡§ï‡•Ä ‡§∏‡§ø‡§´‡§æ‡§∞‡§ø‡§∂</h4>
                    <div class="recommendation">
                        {% if insights.avg_change > 5 %}
                        <span class="rec-text">‡§¨‡•á‡§ö‡§®‡•á ‡§ï‡§æ ‡§Ö‡§ö‡•ç‡§õ‡§æ ‡§∏‡§Æ‡§Ø</span>
                        {% elif insights.avg_change < -5 %}
                        <span class="rec-text">‡§ñ‡§∞‡•Ä‡§¶‡§®‡•á ‡§ï‡§æ ‡§Ö‡§ö‡•ç‡§õ‡§æ ‡§∏‡§Æ‡§Ø</span>
                        {% else %}
                        <span class="rec-text">‡§¨‡§æ‡§ú‡§æ‡§∞ ‡§ï‡§æ ‡§á‡§Ç‡§§‡§ú‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Price Chart Section -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">üìà ‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§ü‡•ç‡§∞‡•á‡§Ç‡§° ‡§ö‡§æ‡§∞‡•ç‡§ü</h2>
            <div class="chart-controls">
                <button class="chart-btn active" onclick="changeChartPeriod('1D')">1D</button>
                <button class="chart-btn" onclick="changeChartPeriod('1W')">1W</button>
                <button class="chart-btn" onclick="changeChartPeriod('1M')">1M</button>
                <button class="chart-btn" onclick="changeChartPeriod('3M')">3M</button>
            </div>
        </div>
        <div class="price-chart" id="priceChart">
            <canvas id="chartCanvas" width="800" height="300"></canvas>
        </div>
    </div>

    <!-- Market Filters -->
    <div class="card">
        <div class="card-header">
            <h1 class="card-title">üìä ‡§≤‡§æ‡§á‡§µ ‡§Æ‡§Ç‡§°‡•Ä ‡§≠‡§æ‡§µ</h1>
            <div class="live-indicator">
                <div class="live-dot"></div>
                LIVE
            </div>
        </div>

        <div class="market-filters">
            <button class="filter-button {{ 'active' if current_filter == 'all' else '' }}"
                    onclick="filterMarket('all')">‡§∏‡§≠‡•Ä ‡§´‡§∏‡§≤‡•á‡§Ç</button>
            <button class="filter-button {{ 'active' if current_filter == 'grains' else '' }}"
                    onclick="filterMarket('grains')">‡§Ö‡§®‡§æ‡§ú</button>
            <button class="filter-button {{ 'active' if current_filter == 'vegetables' else '' }}"
                    onclick="filterMarket('vegetables')">‡§∏‡§¨‡•ç‡§ú‡§ø‡§Ø‡§æ‡§Ç</button>
            <button class="filter-button {{ 'active' if current_filter == 'fruits' else '' }}"
                    onclick="filterMarket('fruits')">‡§´‡§≤</button>
            <button class="filter-button {{ 'active' if current_filter == 'spices' else '' }}"
                    onclick="filterMarket('spices')">‡§Æ‡§∏‡§æ‡§≤‡•á</button>
        </div>

        <!-- Advanced Market Table -->
        <div class="market-table-container">
            <table class="market-table">
                <thead>
                    <tr>
                        <th>‡§´‡§∏‡§≤</th>
                        <th>‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§≠‡§æ‡§µ</th>
                        <th>‡§™‡§∞‡§ø‡§µ‡§∞‡•ç‡§§‡§®</th>
                        <th>% ‡§™‡§∞‡§ø‡§µ‡§∞‡•ç‡§§‡§®</th>
                        <th>‡§Æ‡§Ç‡§°‡•Ä</th>
                        <th>‡§ü‡•ç‡§∞‡•á‡§Ç‡§°</th>
                        <th>‡§è‡§ï‡•ç‡§∂‡§®</th>
                    </tr>
                </thead>
                <tbody>
                    {% for market in market_data %}
                    <tr class="market-row">
                        <td class="crop-cell">
                            <div class="crop-info">
                                <span class="crop-icon">üåæ</span>
                                <span class="crop-name">{{ market.crop_name }}</span>
                            </div>
                        </td>
                        <td class="price-cell">
                            <span class="current-price">‚Çπ{{ market.current_price }}</span>
                            <span class="price-unit">/‡§ï‡•ç‡§µ‡§ø‡§Ç‡§ü‡§≤</span>
                        </td>
                        <td class="change-cell">
                            <span class="price-change {{ 'positive' if market.price_change > 0 else 'negative' }}">
                                {{ '+' if market.price_change > 0 else '' }}‚Çπ{{ market.price_change }}
                            </span>
                        </td>
                        <td class="percentage-cell">
                            <span class="percentage-change {{ 'positive' if market.percentage_change > 0 else 'negative' }}">
                                {{ '+' if market.percentage_change > 0 else '' }}{{ market.percentage_change }}%
                            </span>
                        </td>
                        <td class="location-cell">{{ market.market_location }}</td>
                        <td class="trend-cell">
                            <span class="trend-indicator {{ market.trend }}">
                                {{ 'üìà' if market.trend == 'up' else 'üìâ' }}
                            </span>
                        </td>
                        <td class="action-cell">
                            <button class="action-btn" onclick="getDetailedAnalysis('{{ market.crop_name }}')">
                                ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Price Alerts Section -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">üîî ‡§™‡•ç‡§∞‡§æ‡§á‡§∏ ‡§Ö‡§≤‡§∞‡•ç‡§ü ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç</h2>
        </div>
        <div class="alert-form">
            <div class="form-group">
                <label>‡§´‡§∏‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç:</label>
                <select id="alertCrop">
                    {% for market in market_data %}
                    <option value="{{ market.crop_name }}">{{ market.crop_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>‡§ü‡§æ‡§∞‡§ó‡•á‡§ü ‡§™‡•ç‡§∞‡§æ‡§á‡§∏ (‚Çπ):</label>
                <input type="number" id="alertPrice" placeholder="‚Çπ2000">
            </div>
            <div class="form-group">
                <label>‡§Ö‡§≤‡§∞‡•ç‡§ü ‡§ü‡§æ‡§á‡§™:</label>
                <select id="alertType">
                    <option value="above">‡§ú‡§¨ ‡§¶‡§æ‡§Æ ‡§á‡§∏‡§∏‡•á ‡§ä‡§™‡§∞ ‡§ú‡§æ‡§è</option>
                    <option value="below">‡§ú‡§¨ ‡§¶‡§æ‡§Æ ‡§á‡§∏‡§∏‡•á ‡§®‡•Ä‡§ö‡•á ‡§Ü‡§è</option>
                </select>
            </div>
            <button class="btn-primary" onclick="setAlert()">‡§Ö‡§≤‡§∞‡•ç‡§ü ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/market.js"></script>
<script>
// Initialize chart
document.addEventListener('DOMContentLoaded', function() {
    initializeChart();
    setInterval(updateMarketData, 30000); // Update every 30 seconds
});

function filterMarket(category) {
    window.location.href = `/market?filter_type=${category}`;
}

function getDetailedAnalysis(crop) {
    // Fetch detailed analysis for the crop
    fetch(`/api/crop-analysis/${crop}`)
        .then(response => response.json())
        .then(data => {
            showDetailedAnalysis(data);
        })
        .catch(error => {
            showNotification('‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ', 'error');
        });
}

function setAlert() {
    const crop = document.getElementById('alertCrop').value;
    const price = document.getElementById('alertPrice').value;
    const type = document.getElementById('alertType').value;

    if (!price) {
        showNotification('‡§ï‡•É‡§™‡§Ø‡§æ ‡§ü‡§æ‡§∞‡§ó‡•á‡§ü ‡§™‡•ç‡§∞‡§æ‡§á‡§∏ ‡§°‡§æ‡§≤‡•á‡§Ç', 'warning');
        return;
    }

    // Save alert
    const alert = { crop, price, type, timestamp: new Date() };
    saveAlert(alert);
    showNotification(`${crop} ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ö‡§≤‡§∞‡•ç‡§ü ‡§∏‡•á‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ`, 'success');
}

function changeChartPeriod(period) {
    document.querySelectorAll('.chart-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    updateChart(period);
}
</script>
{% endblock %}